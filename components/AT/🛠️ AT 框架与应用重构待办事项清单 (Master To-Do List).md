---

# 🛠️ AT 框架与应用重构待办事项清单 (Master To-Do List)
> **文档概述**
>
> 本文档整合了代码具体逻辑漏洞分析与市面顶级开源框架（如 RT-Thread AT 组件、Zephyr Modem、FreeRTOS-Plus-TCP）的架构标准。旨在解决系统随机死机、内存踩踏及移植性差等核心问题，并将问题整理为一份分优先级的执行清单。
>

---

## 🚨 第一优先级：架构安全与核心隐患 (Architecture & Safety)
**目标**：解决导致系统随机死机、内存踩踏和无法移植的根本性问题。

### 1. [CRITICAL] 修复“超时释放”引发的 UAF (Use-After-Free) 竞态
+ **现状分析**：  
`AT_Wait` 超时后，用户线程强制回收 `cmd` 对象。但此时 `AT_Core_Task` 可能刚收到数据，正尝试写入该指针。若该对象已被分配给新命令，将导致严重的数据破坏。
+ **行业对标**：  
顶级框架（如 RT-Thread AT）采用严格的**所有权机制**管理内存生命周期。
+ **待办事项 (To-Do)**：
    - [ ] **引入“中止 (Abort)”状态**：超时仅标记状态，资源释放必须由 Core Task 确认不再引用后进行。
    - [ ] **或者实现“取消回调”**：在释放前移除队列中的引用，确保指针安全。

### 2. [CRITICAL] 内存池分配原子性修复
+ **现状分析**：  
在 `AT_CmdFree` 中，`c->in_use = 0` 的操作暴露在互斥锁保护之外，存在多线程竞争风险。
+ **待办事项 (To-Do)**：
    - [ ] **扩大临界区**：将所有状态重置逻辑移入 `pool_mutex` 临界区内，确保多线程下的分配绝对安全。

### 3. [HIGH] 剥离硬件抽象层 (HAL Decoupling)
+ **现状分析**：  
`AT_Core_Init` 深度耦合 `stm32f4xx_hal` 和具体 UART 句柄，导致无法轻易移植。
+ **行业对标**：  
Zephyr/Linux 的设备驱动分离模型。
+ **待办事项 (To-Do)**：
    - [ ] **定义适配器接口**：定义 `AT_Adaptor_Ops` 结构体（包含 `send`, `recv` 函数指针）。
    - [ ] **移除硬编码依赖**：移除核心文件对 `stm32_hal.h` 的包含，通过回调操作硬件，便于移植到 GD32/ESP32 等平台。

---

## 🚀 第二优先级：性能与吞吐量 (Performance)
**目标**：提高大数据量（如 OTA、MQTT）下的传输效率，防止丢包。

### 1. [HIGH] 重构中断接收逻辑 (ISR Optimization)
+ **现状分析**：  
ISR 中使用 `for` 循环 + `AT_HANDLE_BYTE` 逐字节解析，频繁调用 `RingBuffer` 写入函数。
+ **缺陷**：  
高波特率（>115200）下长期占用中断资源，甚至导致系统卡顿。
+ **待办事项 (To-Do)**：
    - [ ] **移除 ISR 内解析**：ISR 仅负责将 DMA 数据块写入 `RingBuffer` 或更新指针，并触发信号量。
    - [ ] **任务级解析**：将解析逻辑移至 `AT_Core_Task`，支持批量读取处理。

### 2. [MEDIUM] 优化环形缓冲区操作
+ **待办事项 (To-Do)**：
    - [ ] **实现块读写 (Batch I/O)**：在 RingBuffer 中实现块读写接口，减少函数调用开销和临界区进出次数。

---

## 🛠 第三优先级：协议栈解析能力 (Protocol Stack)
**目标**：提升对复杂网络环境（分包、乱码、异步消息）的适应能力。

### 1. [HIGH] 实现 URC (非请求结果) 分发路由表
+ **现状分析**：  
所有异步消息（如 `+WIFI:`, `+MQTT:`）都丢给一个大回调函数处理，逻辑耦合严重。
+ **行业对标**：  
通用 AT 组件标准，支持 `AT_Server_RegisterURC("PREFIX", callback)`。
+ **待办事项 (To-Do)**：
    - [ ] **建立路由表**：建立链表或数组路由表。
    - [ ] **自动分发**：解析器根据行首前缀自动分发消息到对应的业务模块（WiFi 模块、Socket 模块）。

### 2. [MEDIUM] 增加二进制/透传模式支持
+ **现状分析**：  
依赖 `\n` 和字符串函数，遇到 `0x00` 或非文本流会截断或死锁。
+ **待办事项 (To-Do)**：
    - [ ] **引入“透传模式 (Transparent Mode)”API**。
    - [ ] **支持指定长度读取**：绕过行解析器，用于 Socket 接收原始数据。

### 3. [MEDIUM] 增强解析器自愈能力
+ **现状分析**：  
依赖“长度前缀”帧同步。一旦 `RingBuffer` 溢出或错位，后续帧全部解析失败。
+ **待办事项 (To-Do)**：
    - [ ] **增加帧头校验逻辑**：当长度校验失败时，自动丢弃数据直到搜索到新的合法行尾（`\r\n`）进行重同步。

### 4. [LOW] 自动过滤回显 (Echo Suppression)
+ **待办事项 (To-Do)**：
    - [ ] **识别并丢弃**：在解析层识别并丢弃与发送缓冲区一致的数据行，防止将回显误判为响应。

---

## 📱 第四优先级：应用层业务逻辑 (Application)
**目标**：消除阻塞，提升用户体验和系统启动速度。

### 1. [HIGH] 移除初始化阻塞 (Non-blocking Init)
+ **现状分析**：  
`esp01s_Init` 使用死循环等待和长延时阻塞，导致 Watchdog 风险。
+ **待办事项 (To-Do)**：
    - [ ] **重构为异步状态机 (FSM)**：发送 AT 命令后退出，通过回调进入下一初始化阶段。

### 2. [MEDIUM] 优化连接与重试策略
+ **现状分析**：  
使用 `while(AT_SendCmd(...) == TIMEOUT)` 进行死循环重试。
+ **待办事项 (To-Do)**：
    - [ ] **引入指数退避算法**：失败等待 1s, 2s, 4s...，并设置最大重试次数。

### 3. [LOW] 配置硬编码解耦
+ **待办事项 (To-Do)**：
    - [ ] **提取配置结构体**：将 WiFi SSID/PWD 等信息提取为配置结构体，支持从 Flash 读取。

---

## 🧹 第五优先级：代码规范与工具 (Code Quality)
**目标**：提升可维护性和调试效率。

### 1. [MEDIUM] 增强调试日志系统
+ **现状分析**：  
日志信息简陋，无法看清协议细节。
+ **待办事项 (To-Do)**：
    - [ ] **增加 HEX Dump 模式**：打印不可见字符（如 `\r`, `\n`, `0x00`），便于排查协议细节。

### 2. [LOW] 清理无用代码与依赖
+ **待办事项 (To-Do)**：
    - [ ] **处理 HFSM 结构体**：移除未使用的 HFSM，或者正式启用它来管理 AT 状态。
    - [ ] **解除循环依赖**：解除 `AT.h` 与 `AT_Core_Task.h` 的循环依赖，提取公共类型至 `AT_Def.h`。
    - [ ] **优化 AT_UartMap**：移除 `AT_UART_MAX` 静态限制，改为动态绑定。

---

## 📅 建议重构路线图 (Roadmap)
为了保证系统稳定性，建议按以下阶段执行：

| 阶段 | 周期 | 核心任务 | 目标 |
| :--- | :--- | :--- | :--- |
| **Phase 1** | **第一周（止血）** | 专注于 **架构安全** 修复（超时竞态、原子锁）和 **中断 ISR** 改造。 | 确保系统不崩溃，建立稳定的基座。 |
| **Phase 2** | **第二周（功能）** | 实现 **URC 路由表** 和 **透传模式**。 | 打通复杂的网络交互功能，支持高级协议。 |
| **Phase 3** | **第三周（优化）** | 改造应用层初始化为 **异步 FSM**，并完善 **日志系统**。 | 提升启动速度与可维护性。 |


